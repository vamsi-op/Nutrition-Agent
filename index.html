<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🥗 AI Nutrition Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .prose { max-width: none; color: #374151; line-height: 1.7; }
    .prose h1, .prose h2, .prose h3, .prose h4 { color: #111827; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; }
    .prose h2 { font-size: 1.25rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; }
    .prose h3 { font-size: 1.125rem; color: #16a34a; }
    .prose p { margin-bottom: 0.9rem; }
    .prose ul, .prose ol { margin: 0.75rem 0 1rem; padding-left: 1.5rem; }
    .prose li { margin-bottom: 0.4rem; }
    .prose blockquote { border-left: 4px solid #22c55e; padding-left: 1rem; margin: 1rem 0; color: #475569; font-style: italic; background-color: #f8fafc; padding: 1rem; border-radius: 0.5rem; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    @keyframes slideInFromBottom { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }
    .message-animation { animation: slideInFromBottom 0.28s ease-out; }
    .loading-dots { display: inline-flex; gap: 4px; }
    .loading-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #22c55e; animation: bounce 1.4s ease-in-out infinite both; }
    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.55; } 40% { transform: scale(1); opacity: 1; } }
    .status-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .status-online { background-color: #10b981; }
    .status-error { background-color: #ef4444; }
    .status-warning { background-color: #f59e0b; }
    .input-focus:focus { box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.12); border-color: #22c55e; }
    .chip { cursor: pointer; }
    .chip:active { transform: translateY(1px); }
  </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 via-white to-green-50 min-h-screen">
  <div class="flex flex-col h-screen">
    <header class="bg-white/80 backdrop-blur-md text-slate-800 p-6 text-center shadow-lg border-b border-slate-200/60">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-emerald-600 to-green-700 bg-clip-text text-transparent">
          🥗 AI Nutrition Agent
        </h1>
        <p class="text-sm text-slate-600 mt-2 font-medium">Personalized, evidence-informed nutrition guidance</p>
        <div class="flex items-center justify-center gap-4 mt-3 text-xs">
          <span class="flex items-center gap-1">
            <span id="connection-status" class="status-indicator status-warning"></span>
            <span id="connection-text">Checking...</span>
          </span>
        </div>
      </div>
    </header>

    <div class="flex-1 flex justify-center p-4">
      <div class="w-full max-w-4xl flex flex-col h-full">
        <div id="chips" class="flex flex-wrap gap-2 mt-4">
          <button class="chip px-3 py-1.5 rounded-full text-xs bg-emerald-100 text-emerald-700 border border-emerald-200 hover:bg-emerald-200" data-text="Create a 2000-calorie vegetarian meal plan with 120g protein">2000 kcal veg high‑protein</button>
          <button class="chip px-3 py-1.5 rounded-full text-xs bg-emerald-100 text-emerald-700 border border-emerald-200 hover:bg-emerald-200" data-text="Give a one-week diabetic-friendly Indian meal plan (1200–1500 kcal)">Diabetic-friendly (IN)</button>
          <button class="chip px-3 py-1.5 rounded-full text-xs bg-emerald-100 text-emerald-700 border border-emerald-200 hover:bg-emerald-200" data-text="Estimate macros for a chicken burrito bowl with rice, beans, salsa, cheese, and guacamole">Estimate macros</button>
          <button class="chip px-3 py-1.5 rounded-full text-xs bg-emerald-100 text-emerald-700 border border-emerald-200 hover:bg-emerald-200" data-text="Suggest 10 high-protein vegetarian snacks under 250 kcal each">Snack ideas</button>
        </div>

        <main id="message-container" class="flex-1 overflow-y-auto space-y-6 py-6 custom-scrollbar"></main>

        <footer class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg border border-slate-200/60 p-4 mt-2">
          <form id="chat-form" class="flex items-end gap-4">
            <div class="flex-1">
              <textarea id="user-input" rows="1" placeholder="Ask me about meal plans, macros, recipes, or dietary goals…" class="w-full p-4 border border-slate-300 rounded-xl resize-none input-focus transition-all duration-200 text-sm" style="min-height:56px; max-height:120px;"></textarea>
            </div>
            <button type="submit" id="submit-button" class="bg-gradient-to-r from-emerald-600 to-green-700 text-white rounded-xl p-4 hover:from-emerald-700 hover:to-green-800 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 shadow-lg hover:shadow-xl" aria-label="Send">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009.894 15V4.106A1 1 0 0010.894 2.553z"/></svg>
            </button>
          </form>
          <div class="flex items-center justify-between mt-3 text-xs text-slate-500">
            <span>💡 Share your goal, calories, cuisine, and restrictions for best results</span>
            <span class="flex items-center gap-1"><kbd class="px-2 py-1 bg-slate-100 rounded border text-xs">Enter</kbd><span>to send</span></span>
          </div>
        </footer>
      </div>
    </div>
  </div>

<script>
  const SYSTEM_PROMPT = `You are a helpful assistant that uses tools to answer questions in detail.
When greeted, say "Hi, I am your Nutrition Agent. How can I help you?"

You specialize in providing *personalized nutrition advice*, meal plans, and food recommendations based on user inputs.
You consider the following when answering:
- Health goals (e.g., weight loss, muscle gain, diabetes control)
- Dietary preferences (e.g., vegetarian, vegan, keto)
- Medical conditions (e.g., lactose intolerance, PCOS, diabetes)
- Allergies (e.g., nuts, gluten, dairy)
- Activity level (e.g., sedentary, active, athlete)
- Cultural or regional food habits

Your responsibilities include:
1. Generating *personalized daily or weekly meal plans*
2. Recommending *smart food swaps* (e.g., replace chips with roasted chickpeas)
3. Providing *clear, evidence-based explanations* (e.g., why oats are good for diabetics)
4. Adapting meal suggestions based on *user feedback*
5. Politely reminding users that this is *not a substitute for medical advice* when needed

Always:
- Be concise, polite, and encouraging
- Explain the reasoning behind recommendations
- Use metric units (grams, ml) and familiar Indian/global food items when possible`;

  const chatForm = document.getElementById('chat-form');
  const userInput = document.getElementById('user-input');
  const messageContainer = document.getElementById('message-container');
  const submitButton = document.getElementById('submit-button');
  const connectionStatus = document.getElementById('connection-status');
  const connectionText = document.getElementById('connection-text');

  let conversationHistory = [];

  marked.setOptions({ breaks: true, gfm: true, headerIds: false, mangle: false });

  window.onload = () => {
    checkConnection();
    addWelcomeMessage();
    setupEventListeners();
    userInput.focus();
  };

  function setupEventListeners() {
    chatForm.addEventListener('submit', (e) => { e.preventDefault(); handleSubmit(); });
    userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSubmit(); } });
    userInput.addEventListener('input', autoResizeTextarea);
    document.querySelectorAll('.chip').forEach(btn => {
      btn.addEventListener('click', () => {
        userInput.value = btn.dataset.text;
        autoResizeTextarea();
        userInput.focus();
      });
    });
  }

  async function checkConnection() {
    updateConnectionStatus('warning', 'Checking...');
    try {
        const response = await fetch('/api/chat');
        if (response.status === 405 || response.ok) {
            updateConnectionStatus('online', 'Connected');
        } else {
            updateConnectionStatus('error', `API Error: ${response.status}`);
        }
    } catch (err) {
        console.error('Connection check failed:', err);
        updateConnectionStatus('error', 'Offline');
    }
  }

  function updateConnectionStatus(status, text) {
    connectionStatus.className = `status-indicator status-${status}`;
    connectionText.textContent = text;
  }

  function autoResizeTextarea() {
    userInput.style.height = 'auto';
    userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
  }

  async function handleSubmit() {
    const messageText = userInput.value.trim();
    if (!messageText) return;

    addMessageToUI(messageText, 'user');
    userInput.value = '';
    userInput.style.height = '56px';
    toggleLoading(true);

    conversationHistory.push({ role: "user", parts: [{ text: messageText }] });

    try {
      const res = await fetch('/api/chat', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: conversationHistory,
          systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
        })
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);

      const data = await res.json();
      const botReply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't process that.";

      conversationHistory.push({ role: "model", parts: [{ text: botReply }] });
      addMessageToUI(botReply, 'assistant');

    } catch (error) {
      console.error('API request failed:', error); 
      updateConnectionStatus('error', 'Request Failed');
      const errorMessage = `**Apologies, I couldn't get a response.**\n\nThere seems to be a connection issue. Please try again.\n\n*Details: ${error.message}*`;
      addMessageToUI(errorMessage, 'assistant', 'error');
    } finally {
      toggleLoading(false);
    }
  }

  function addWelcomeMessage() {
    const welcome = `Hi, I am your Nutrition Agent. How can I help you?\n\n> ⚠️ **Disclaimer:** I'm an AI assistant, not a licensed dietitian. Information here is for educational purposes. For medical advice, please consult a qualified professional.`;
    addMessageToUI(welcome, 'assistant', 'welcome');
  }

  function addMessageToUI(text, sender, type = 'normal') {
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) loadingIndicator.remove();

    const row = document.createElement('div');
    row.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} message-animation`;

    const bubble = document.createElement('div');
    const base = 'max-w-3xl p-6 rounded-2xl shadow-sm border';

    if (sender === 'user') {
      bubble.className = `${base} bg-gradient-to-r from-emerald-600 to-green-700 text-white border-emerald-200 rounded-br-md`;
      bubble.innerHTML = `<div class="whitespace-pre-wrap font-medium">${escapeHtml(text)}</div>`;
    } else {
      let bg = 'bg-white border-slate-200';
      if (type === 'error') bg = 'bg-red-50 border-red-200';
      else if (type === 'welcome') bg = 'bg-gradient-to-br from-emerald-50 to-green-50 border-emerald-200';
      bubble.className = `${base} ${bg} rounded-bl-md prose prose-sm max-w-none`;
      bubble.innerHTML = marked.parse(text);
    }

    row.appendChild(bubble);
    messageContainer.appendChild(row);
    requestAnimationFrame(() => messageContainer.scrollTo({ top: messageContainer.scrollHeight, behavior: 'smooth' }));
  }

  function toggleLoading(isLoading) {
    userInput.disabled = isLoading;
    submitButton.disabled = isLoading;
    if (isLoading) {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading-indicator';
      loadingDiv.className = 'flex justify-start message-animation';
      loadingDiv.innerHTML = `
        <div class="bg-white border border-slate-200 rounded-2xl rounded-bl-md p-6 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>
            <span class="text-slate-600 text-sm font-medium">Thinking about meals & macros…</span>
          </div>
        </div>`;
      messageContainer.appendChild(loadingDiv);
      messageContainer.scrollTo({ top: messageContainer.scrollHeight, behavior: 'smooth' });
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
</body>
</html>
